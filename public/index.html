<!DOCTYPE html>
<html>
<head>
<title>Office Spotify Skip</title>
<style>
body {
  margin: 0;
  font-family: Arial, sans-serif;
  color: white;
  background: black;
  overflow: hidden;
}

/* Blurred album background */
#bg {
  position: fixed;
  width: 100%;
  height: 100%;
  background-size: cover;
  background-position: center;
  filter: blur(60px) brightness(0.4);
  transform: scale(1.2);
  z-index: -1;
  transition: background-image 0.6s ease;
}

.container {
  text-align: center;
  padding-top: 80px;
}

#albumCover {
  width: 250px;
  border-radius: 15px;
}

.vote-counter {
  font-size: 22px;
  margin-top: 10px;
  transition: transform 0.3s ease;
}

.progress-container {
  background: rgba(255,255,255,0.2);
  height: 8px;
  border-radius: 10px;
  width: 300px;
  margin: 15px auto;
}
#progressBar {
  height: 100%;
  width: 0%;
  background: #1DB954;
  border-radius: 10px;
}

#skipBtn {
  background: #1DB954;
  border: none;
  padding: 15px 40px;
  border-radius: 50px;
  font-size: 18px;
  cursor: pointer;
}

/* Sound wave visualizer */
.wave {
  display: flex;
  justify-content: center;
  gap: 4px;
  margin-top: 15px;
}
.bar {
  width: 4px;
  height: 10px;
  background: #1DB954;
  animation: bounce 1s infinite ease-in-out;
}
.bar:nth-child(2){animation-delay:0.1s;}
.bar:nth-child(3){animation-delay:0.2s;}
.bar:nth-child(4){animation-delay:0.3s;}
.bar:nth-child(5){animation-delay:0.4s;}

@keyframes bounce {
  0%,100%{height:10px;}
  50%{height:30px;}
}

/* Admin */
#adminBtn {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: #1DB954;
  border-radius: 50%;
  width: 55px;
  height: 55px;
  border: none;
  font-size: 20px;
  cursor: pointer;
}

#adminPanel {
  position: fixed;
  bottom: 90px;
  right: 20px;
  background: #181818;
  padding: 15px;
  border-radius: 10px;
  display: none;
  width: 200px;
}
input { width: 100%; margin-bottom: 8px; padding: 6px; }
button.small { width: 100%; margin-top: 5px; }
</style>
</head>

<body>

<div id="bg"></div>

<div class="container">
<img id="albumCover">
<h2 id="songTitle">Loading...</h2>
<div id="artistName"></div>

<div class="wave">
<div class="bar"></div>
<div class="bar"></div>
<div class="bar"></div>
<div class="bar"></div>
<div class="bar"></div>
</div>

<div class="progress-container">
<div id="progressBar"></div>
</div>

<div id="voteCounter" class="vote-counter">0 / 0 votes</div>

<button id="skipBtn" onclick="vote()">SKIP</button>

<ul id="voters"></ul>
</div>

<button id="adminBtn" onclick="showLogin()">âš™</button>

<div id="adminPanel">
<div id="loginSection">
<input type="password" id="adminPasswordInput" placeholder="Admin password">
<button class="small" onclick="adminLogin()">Login</button>
</div>

<div id="adminControls" style="display:none;">
<input id="totalInput" type="number" placeholder="People">
<button class="small" onclick="setTotal()">Set People</button>
<button class="small" onclick="toggleVoting()">Toggle Voting</button>
</div>
</div>

<script>
let userId = localStorage.getItem("userId");
let userName = localStorage.getItem("userName");
let lastCount = 0;

if (!userId) {
  userId = crypto.randomUUID();
  localStorage.setItem("userId", userId);
}
if (!userName) {
  userName = prompt("Enter your name:");
  localStorage.setItem("userName", userName);
}

function vote(){
fetch("/vote",{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({userId,name:userName})
})
.then(res=>res.json())
.then(updateUI);
}

function updateUI(data){

if(data.count !== lastCount){
document.getElementById("voteCounter").style.transform="scale(1.3)";
setTimeout(()=>document.getElementById("voteCounter").style.transform="scale(1)",200);
}
lastCount=data.count;

document.getElementById("voteCounter").innerText =
`${data.count} / ${data.needed} votes`;

const percent=data.needed>0?(data.count/data.needed)*100:0;
document.getElementById("progressBar").style.width=
Math.min(percent,100)+"%";

const list=document.getElementById("voters");
list.innerHTML="";
data.voters.forEach(v=>{
const li=document.createElement("li");
li.innerText=v;
list.appendChild(li);
});
}

function loadVotes(){
fetch("/votes")
.then(res=>res.json())
.then(updateUI);
}

function loadSong(){
fetch("/current-song")
.then(res=>res.json())
.then(data=>{
if(!data.title)return;
const parts=data.title.split(" - ");
document.getElementById("songTitle").innerText=parts[0];
document.getElementById("artistName").innerText=parts[1]||"";
if(data.image){
document.getElementById("albumCover").src=data.image;
document.getElementById("bg").style.backgroundImage=`url(${data.image})`;
}
loadVotes();
});
}

function showLogin(){
document.getElementById("adminPanel").style.display="block";
}

function adminLogin(){
const password=document.getElementById("adminPasswordInput").value;

fetch("/admin-auth",{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({password})
})
.then(res=>{
if(res.status===403){alert("Wrong password");return;}
document.getElementById("loginSection").style.display="none";
document.getElementById("adminControls").style.display="block";
document.getElementById("adminBtn").style.display="none";
localStorage.setItem("adminPassword",password);
});
}

function setTotal(){
const total=document.getElementById("totalInput").value;
const password=localStorage.getItem("adminPassword");
fetch("/set-total",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({total,password})})
.then(()=>loadVotes());
}

function toggleVoting(){
const password=localStorage.getItem("adminPassword");
fetch("/toggle-voting",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({password})});
}

loadSong();
loadVotes();

setInterval(loadSong,10000);
</script>

</body>
</html>

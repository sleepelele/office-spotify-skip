<!DOCTYPE html>
<html>
<head>
<title>Office Spotify Skip</title>
<style>
/* same styling as before — unchanged */
body { margin:0;font-family:Arial;background:black;color:white;overflow:hidden;}
#bg{position:fixed;width:100%;height:100%;background-size:cover;background-position:center;filter:blur(60px) brightness(0.4);transform:scale(1.2);z-index:-1;transition:background-image 0.6s ease;}
.layout{display:flex;}
.side-panel{width:280px;background:rgba(0,0,0,0.6);padding:20px;backdrop-filter:blur(20px);height:100vh;}
.container{flex:1;text-align:center;padding-top:80px;}
#albumCover{width:250px;border-radius:15px;}
.progress-container{background:rgba(255,255,255,0.2);height:8px;border-radius:10px;width:300px;margin:15px auto;}
#progressBar{height:100%;width:0%;background:#1DB954;border-radius:10px;}
#voteCounter{font-size:20px;margin-top:10px;transition:transform 0.2s ease;}
#skipBtn{background:#1DB954;border:none;padding:15px 40px;border-radius:50px;font-size:18px;cursor:pointer;}
#adminBtn{position:fixed;bottom:20px;right:20px;background:#1DB954;border-radius:50%;width:55px;height:55px;border:none;font-size:20px;cursor:pointer;}
#adminPanel{position:fixed;bottom:90px;right:20px;background:#181818;padding:15px;border-radius:10px;display:none;width:200px;}
input{width:100%;margin-bottom:8px;padding:6px;}
button.small{width:100%;margin-top:5px;}
ul{list-style:none;padding:0;}
</style>
</head>
<body>

<div id="bg"></div>

<div class="layout">

<div class="side-panel">
<h3>Last Skip</h3>
<div id="lastSkipPanel">No skips yet</div>
</div>

<div class="container">
<img id="albumCover">
<h2 id="songTitle">Loading...</h2>
<div id="artistName"></div>

<div class="progress-container">
<div id="progressBar"></div>
</div>

<div id="voteCounter">0 / 0 votes</div>

<button id="skipBtn" onclick="vote()">SKIP</button>

<ul id="voters"></ul>
</div>
</div>

<button id="adminBtn" onclick="adminButtonClick()">⚙</button>

<div id="adminPanel">
<div id="loginSection">
<input type="password" id="adminPasswordInput" placeholder="Admin password">
<button class="small" onclick="adminLogin()">Login</button>
</div>

<div id="adminControls" style="display:none;">
<input id="totalInput" type="number" placeholder="People">
<button class="small" onclick="setTotal()">Set People</button>
<button class="small" onclick="toggleVoting()">Toggle Voting</button>
<button class="small" onclick="toggleSound()">Toggle Ping Sound</button>
</div>
</div>

<script>
const pingSound = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");

let userId = localStorage.getItem("userId");
let userName = localStorage.getItem("userName");
let adminLoggedIn = false;
let lastCount = 0;
let soundEnabled = true;

if (!userId) {
  userId = crypto.randomUUID();
  localStorage.setItem("userId", userId);
}
if (!userName) {
  userName = prompt("Enter your name:");
  localStorage.setItem("userName", userName);
}

function vote(){
fetch("/vote",{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({userId,name:userName})
})
.then(res=>res.json())
.then(data=>{
if(data.soundEnabled && data.count > lastCount){
pingSound.play().catch(()=>{});
}
updateUI(data);
});
}

function updateUI(data){
lastCount=data.count;
soundEnabled=data.soundEnabled;

document.getElementById("voteCounter").innerText =
`${data.count} / ${data.needed} votes`;

const percent=data.needed>0?(data.count/data.needed)*100:0;
document.getElementById("progressBar").style.width=
Math.min(percent,100)+"%";

const list=document.getElementById("voters");
list.innerHTML="";
data.voters.forEach(v=>{
const li=document.createElement("li");
li.innerText=v;
list.appendChild(li);
});
}

function loadVotes(){
fetch("/votes").then(res=>res.json()).then(updateUI);
}

function loadSong(){
fetch("/current-song")
.then(res=>res.json())
.then(data=>{
if(!data.title)return;
const parts=data.title.split(" - ");
document.getElementById("songTitle").innerText=parts[0];
document.getElementById("artistName").innerText=parts[1]||"";
if(data.image){
document.getElementById("albumCover").src=data.image;
document.getElementById("bg").style.backgroundImage=`url(${data.image})`;
}
loadVotes();
});
}

function loadLastSkip(){
fetch("/last-skip")
.then(res=>res.json())
.then(data=>{
const panel=document.getElementById("lastSkipPanel");
if(!data){panel.innerHTML="No skips yet";return;}
panel.innerHTML=`
<p><strong>Song:</strong><br>${data.song}</p>
<p><strong>Skipped By:</strong></p>
<ul>${data.skippedBy.map(n=>`<li>${n}</li>`).join("")}</ul>
<p><strong>Time:</strong><br>${data.time}</p>
`;
});
}

function adminButtonClick(){
const panel=document.getElementById("adminPanel");
panel.style.display = panel.style.display==="none"?"block":"none";
}

function adminLogin(){
const password=document.getElementById("adminPasswordInput").value;

fetch("/admin-auth",{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({password})
})
.then(res=>{
if(res.status===403){alert("Wrong password");return;}
adminLoggedIn=true;
document.getElementById("loginSection").style.display="none";
document.getElementById("adminControls").style.display="block";
});
}

function setTotal(){
const total=document.getElementById("totalInput").value;
const password=document.getElementById("adminPasswordInput").value;
fetch("/set-total",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({total,password})})
.then(()=>loadVotes());
}

function toggleVoting(){
const password=document.getElementById("adminPasswordInput").value;
fetch("/toggle-voting",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({password})});
}

function toggleSound(){
const password=document.getElementById("adminPasswordInput").value;
fetch("/toggle-sound",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({password})})
.then(()=>loadVotes());
}

loadSong();
loadVotes();
loadLastSkip();

setInterval(loadSong,10000);
setInterval(loadLastSkip,5000);
</script>

</body>
</html>

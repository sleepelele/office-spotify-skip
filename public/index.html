<!DOCTYPE html>
<html>
<head>
<title>Office Spotify Skip</title>
<style>
body {
  margin: 0;
  font-family: Arial;
  background: black;
  color: white;
  overflow: hidden;
}

/* Background blur */
#bg {
  position: fixed;
  width: 100%;
  height: 100%;
  background-size: cover;
  background-position: center;
  filter: blur(60px) brightness(0.4);
  transform: scale(1.2);
  z-index: -1;
  transition: background-image 0.6s ease;
}

.layout { display: flex; }

.side-panel {
  width: 280px;
  background: rgba(0,0,0,0.6);
  padding: 20px;
  backdrop-filter: blur(20px);
  height: 100vh;
}

.container {
  flex: 1;
  text-align: center;
  padding-top: 80px;
}

#albumCover {
  width: 250px;
  border-radius: 15px;
}

.progress-container {
  background: rgba(255,255,255,0.2);
  height: 8px;
  border-radius: 10px;
  width: 300px;
  margin: 15px auto;
}

#progressBar {
  height: 100%;
  width: 0%;
  background: #1DB954;
  border-radius: 10px;
}

#voteCounter {
  font-size: 20px;
  margin-top: 10px;
  transition: transform 0.2s ease;
}

#skipBtn {
  background: #1DB954;
  border: none;
  padding: 15px 40px;
  border-radius: 50px;
  font-size: 18px;
  cursor: pointer;
}

/* Admin Button */
#adminBtn {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: #1DB954;
  border-radius: 50%;
  width: 55px;
  height: 55px;
  border: none;
  font-size: 20px;
  cursor: pointer;
}

/* Admin Panel */
#adminPanel {
  position: fixed;
  bottom: 90px;
  right: 20px;
  background: #181818;
  padding: 15px;
  border-radius: 10px;
  display: none;
  width: 220px;
}

input { width: 100%; margin-bottom: 10px; padding: 6px; }

.switch-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin: 10px 0;
}

/* Switch style */
.switch {
  width: 50px;
  height: 24px;
  background: red;
  border-radius: 12px;
  position: relative;
  cursor: pointer;
  transition: background 0.3s;
}

.switch::after {
  content: "";
  width: 20px;
  height: 20px;
  background: white;
  border-radius: 50%;
  position: absolute;
  top: 2px;
  left: 2px;
  transition: transform 0.3s;
}

.switch.on {
  background: #1DB954;
}

.switch.on::after {
  transform: translateX(26px);
}

ul { list-style: none; padding: 0; }
</style>
</head>

<body>

<div id="bg"></div>

<div class="layout">

<div class="side-panel">
<h3>Last Skip</h3>
<div id="lastSkipPanel">No skips yet</div>
</div>

<div class="container">
<img id="albumCover">
<h2 id="songTitle">Loading...</h2>
<div id="artistName"></div>

<div class="progress-container">
<div id="progressBar"></div>
</div>
<img id="cornerGif"
     src="/dancer.gif"
     style="
       position: fixed;
       bottom: 20px;
       left: 20px;
       width: 140px;
       pointer-events: none;
       z-index: 5;
       opacity: 0.9;
     ">
  <img id="topRightGif"
     src="/penguin.gif"
     style="
       position: fixed;
       top: 20px;
       right: 20px;
       width: 120px;
       pointer-events: none;
       z-index: 5;
       opacity: 0.95;
     ">
<div id="voteCounter">0 / 0 votes</div>

<button id="skipBtn" onclick="vote()">SKIP</button>

<ul id="voters"></ul>
</div>

</div>

<button id="adminBtn" onclick="toggleAdminPanel()">âš™</button>

<div id="adminPanel">

<div id="loginSection">
<input type="password" id="adminPasswordInput" placeholder="Admin password">
<button onclick="adminLogin()">Login</button>
</div>

<div id="adminControls" style="display:none;">

<input id="totalInput" type="number" placeholder="People">
<button onclick="setTotal()">Set People</button>

<div class="switch-row">
<span>Voting</span>
<div id="votingSwitch" class="switch" onclick="toggleVoting()"></div>
</div>

<div class="switch-row">
<span>Ping Sound</span>
<div id="soundSwitch" class="switch" onclick="toggleSound()"></div>
</div>

</div>

</div>

<script>
const pingSound = new Audio("https://actions.google.com/sounds/v1/cartoon/pop.ogg");

let userId = localStorage.getItem("userId");
let userName = localStorage.getItem("userName");
let adminLoggedIn = false;
let lastCount = 0;

if (!userId) {
  userId = crypto.randomUUID();
  localStorage.setItem("userId", userId);
}
if (!userName) {
  userName = prompt("Enter your name:");
  localStorage.setItem("userName", userName);
}

function vote(){
fetch("/vote",{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({userId,name:userName})
})
.then(res=>res.json())
.then(data=>{
if(data.soundEnabled && data.count > lastCount){
pingSound.play().catch(()=>{});
}
updateUI(data);
});
}

function updateUI(data){

if(data.count !== lastCount){
document.getElementById("voteCounter").style.transform="scale(1.3)";
setTimeout(()=>document.getElementById("voteCounter").style.transform="scale(1)",200);
}
lastCount=data.count;

document.getElementById("voteCounter").innerText =
`${data.count} / ${data.needed} votes`;

const percent=data.needed>0?(data.count/data.needed)*100:0;
document.getElementById("progressBar").style.width =
Math.min(percent,100)+"%";

const list=document.getElementById("voters");
list.innerHTML="";
data.voters.forEach(v=>{
const li=document.createElement("li");
li.innerText=v;
list.appendChild(li);
});

updateSwitch("votingSwitch", data.votingEnabled);
updateSwitch("soundSwitch", data.soundEnabled);
}

function updateSwitch(id, state){
const el = document.getElementById(id);
if(state){
el.classList.add("on");
}else{
el.classList.remove("on");
}
}

function loadVotes(){
fetch("/votes").then(res=>res.json()).then(updateUI);
}

function loadSong(){
fetch("/current-song")
.then(res=>res.json())
.then(data=>{
if(!data.title)return;
const parts=data.title.split(" - ");
document.getElementById("songTitle").innerText=parts[0];
document.getElementById("artistName").innerText=parts[1]||"";
if(data.image){
document.getElementById("albumCover").src=data.image;
document.getElementById("bg").style.backgroundImage=`url(${data.image})`;
}
loadVotes();
});
}

function loadLastSkip(){
fetch("/last-skip")
.then(res=>res.json())
.then(data=>{
const panel=document.getElementById("lastSkipPanel");
if(!data){panel.innerHTML="No skips yet";return;}
panel.innerHTML=`
<p><strong>Song:</strong><br>${data.song}</p>
<p><strong>Skipped By:</strong></p>
<ul>${data.skippedBy.map(n=>`<li>${n}</li>`).join("")}</ul>
<p><strong>Time:</strong><br>${data.time}</p>
`;
});
}

function toggleAdminPanel(){
const panel=document.getElementById("adminPanel");
panel.style.display = panel.style.display==="none"?"block":"none";
}

function adminLogin(){
const password=document.getElementById("adminPasswordInput").value;

fetch("/admin-auth",{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({password})
})
.then(res=>{
if(res.status===403){alert("Wrong password");return;}
adminLoggedIn=true;
document.getElementById("loginSection").style.display="none";
document.getElementById("adminControls").style.display="block";
});
}

function setTotal(){
const total=document.getElementById("totalInput").value;
const password=document.getElementById("adminPasswordInput").value;
fetch("/set-total",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({total,password})})
.then(()=>loadVotes());
}

function toggleVoting(){
const password=document.getElementById("adminPasswordInput").value;
fetch("/toggle-voting",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({password})})
.then(()=>loadVotes());
}

function toggleSound(){
const password=document.getElementById("adminPasswordInput").value;
fetch("/toggle-sound",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({password})})
.then(()=>loadVotes());
}

loadSong();
loadVotes();
loadLastSkip();

setInterval(loadSong,10000);
setInterval(loadLastSkip,5000);
</script>

</body>
</html>

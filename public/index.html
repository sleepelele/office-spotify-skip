<!DOCTYPE html>
<html>
<head>
  <title>Office Skip Vote</title>
</head>
<body style="text-align:center;font-family:sans-serif;margin-top:80px;background:#f4f6f8;">

  <h1>Office Skip Vote</h1>

  <h2 id="currentSong">Loading song...</h2>

  <img id="albumCover"
     src=""
     style="width:250px;height:250px;border-radius:20px;margin-top:20px;
            box-shadow:0 10px 30px rgba(0,0,0,0.3);
            transition:transform 0.3s ease;">

  <br><br>

  <!-- ADMIN PANEL -->
  <div style="margin-bottom:30px;padding:15px;background:#ffffff;border-radius:15px;display:inline-block;box-shadow:0 5px 15px rgba(0,0,0,0.1);">
    
    <input id="adminPassword" type="password" placeholder="Admin password"
      style="padding:8px;border-radius:8px;border:1px solid #ccc;">

    <br><br>

    <input id="totalInput" type="number" placeholder="Number of people"
      style="padding:8px;border-radius:8px;border:1px solid #ccc;">
    <button onclick="setTotal()">Set Total</button>

    <br><br>

    <button onclick="toggleVoting()">Toggle Voting On / Off</button>
  </div>

  <!-- SKIP BUTTON -->
  <br>

  <button id="skipBtn" onclick="vote()"
    style="
      font-size:28px;
      padding:18px 40px;
      border:none;
      border-radius:40px;
      background:linear-gradient(135deg,#ff4081,#f50057);
      color:white;
      cursor:pointer;
      transition:all 0.2s ease;
    ">
    SKIP
  </button>

  <p id="result" style="margin-top:20px;font-size:18px;"></p>

  <h3>Voters:</h3>
  <ul id="voters" style="list-style:none;padding:0;"></ul>

  <!-- Progress Bar -->
  <div style="width:60%;margin:20px auto;background:#ddd;height:25px;border-radius:20px;overflow:hidden;">
    <div id="progressBar"
      style="height:100%;width:0%;background:linear-gradient(90deg,#4caf50,#81c784);transition:width 0.5s ease;">
    </div>
  </div>

<script>
  const pingSound = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");
  let lastVoteCount = 0;

  let userId = localStorage.getItem("userId");
  let userName = localStorage.getItem("userName");

  if (!userId) {
    userId = crypto.randomUUID();
    localStorage.setItem("userId", userId);
  }

  if (!userName) {
    userName = prompt("Enter your name (only once):");
    localStorage.setItem("userName", userName);
  }

  function vote() {
    const btn = document.getElementById("skipBtn");
    btn.style.transform = "scale(0.95)";
    setTimeout(() => btn.style.transform = "scale(1)", 150);

    fetch("/vote", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ userId, name: userName })
    })
    .then(res => res.json())
    .then(updateUI);
  }

  function refreshVotes() {
    fetch("/votes")
      .then(res => res.json())
      .then(updateUI);
  }

  function updateUI(data) {

    if (data.count > lastVoteCount) {
      pingSound.play().catch(() => {});
    }
    lastVoteCount = data.count;

    document.getElementById("result").innerText =
      `Votes: ${data.count}/${data.needed}`;

    const voterList = document.getElementById("voters");
    voterList.innerHTML = "";

    data.voters.forEach(v => {
      const li = document.createElement("li");
      li.innerText = v;
      li.style.opacity = "0";
      li.style.transition = "opacity 0.5s";
      voterList.appendChild(li);
      setTimeout(() => li.style.opacity = "1", 50);
    });

    const percentage = (data.count / data.needed) * 100;
    document.getElementById("progressBar").style.width =
      Math.min(percentage, 100) + "%";

    const button = document.getElementById("skipBtn");

    if (!data.votingEnabled) {
      button.disabled = true;
      button.innerText = "Voting Disabled";
      return;
    }

    if (data.cooldown) {
      button.disabled = true;
      button.innerText = "Cooldown...";
    } else {
      button.disabled = false;
      button.innerText = "SKIP";
    }
  }

  function loadSong() {
    fetch("/current-song")
      .then(res => res.json())
      .then(data => {

        document.getElementById("currentSong").innerText = data.title;

        const album = document.getElementById("albumCover");

        if (data.image) {
          album.src = data.image;
          album.style.transform = "scale(0.95)";
          setTimeout(() => album.style.transform = "scale(1)", 150);
        }
      });
  }

  function setTotal() {
    const value = document.getElementById("totalInput").value;
    const password = document.getElementById("adminPassword").value;

    fetch("/set-total", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ total: value, password })
    })
    .then(res => res.json())
    .then(data => {
      if (data.success) {
        alert("Total updated");
      } else {
        alert("Wrong password");
      }
    });
  }

  function toggleVoting() {
    const password = document.getElementById("adminPassword").value;

    fetch("/toggle-voting", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({ password })
    })
    .then(res => res.json())
    .then(data => {
      if (!data.success) {
        alert("Wrong password");
      } else {
        alert("Voting is now " + (data.votingEnabled ? "ENABLED" : "DISABLED"));
      }
    });
  }

  loadSong();
  refreshVotes();

  setInterval(loadSong, 10000);
  setInterval(refreshVotes, 3000);

</script>

</body>
</html>
